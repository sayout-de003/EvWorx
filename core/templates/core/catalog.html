{% extends 'core/base.html' %}
{% block title %}Catalog{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">

    <!-- Hero Section -->
    <div class="relative overflow-hidden bg-gradient-to-r from-indigo-900 via-purple-900 to-pink-900 text-white">
        <div class="absolute inset-0 bg-black/30"></div>
        <div class="absolute inset-0 bg-gradient-to-r from-blue-600/20 to-purple-600/20"></div>
        <div class="relative max-w-7xl mx-auto px-4 py-24 text-center animate-fadeIn">
            <h1 class="text-5xl md:text-6xl font-black tracking-tight mb-6">
                <span class="bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">
                    Premium
                </span>
                <span class="text-white"> Catalog</span>
            </h1>
            <p class="text-xl text-blue-100 max-w-2xl mx-auto leading-relaxed mb-8">
                Discover our curated collection of automotive excellence
            </p>
            <a href="#catalog" class="px-8 py-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full text-lg font-semibold shadow-lg hover:scale-105 transition-transform">
                Explore Now *
            </a>
        </div>
    </div>

    <div id="catalog" class="max-w-7xl mx-auto px-4 mt-8 relative z-10">

        <!-- Filter/Search/Sort Bar -->
        <div id="filterBar" class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-50">
            <div class="flex flex-col lg:flex-row items-center justify-between px-4 py-3 gap-3">
                <div class="flex-1 w-full lg:w-auto">
                    <form method="get" class="flex w-full">
                        <input type="text" name="search" value="{{ search_query|default_if_none:'' }}" placeholder="Search products..."
                               class="flex-[2] p-3 border-2 border-gray-200 rounded-xl lg:rounded-l-xl focus:outline-none">
                        <button type="submit" class="px-4 bg-indigo-600 text-white rounded-r-xl lg:rounded-l-none hover:bg-indigo-700 transition">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>

                <div class="hidden lg:flex flex-1 justify-between gap-4">
                    <form method="get" class="flex flex-1 gap-4 w-full">
                        <select name="vehicle_id" class="flex-[3] p-3 bg-white border-2 border-gray-200 rounded-xl">
                            <option value="">All Vehicles</option>
                            {% for vehicle in vehicles %}
                                <option value="{{ vehicle.id }}" {% if selected_vehicle == vehicle.id|stringformat:"s" %}selected{% endif %}>
                                    {{ vehicle.brand.name }} {{ vehicle.model }} ({{ vehicle.year }})
                                </option>
                            {% endfor %}
                        </select>

                        <select name="category" class="flex-[3] p-3 bg-white border-2 border-gray-200 rounded-xl">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>

                        <select name="brand" class="flex-[3] p-3 bg-white border-2 border-gray-200 rounded-xl">
                            <option value="">All Brands</option>
                            {% for brand in brands %}
                                <option value="{{ brand.id }}" {% if selected_brand == brand.id|stringformat:"s" %}selected{% endif %}>
                                    {{ brand.name }}
                                </option>
                            {% endfor %}
                        </select>

                        <select name="sort" class="flex-[2] p-3 bg-white border-2 border-gray-200 rounded-xl">
                            <option value="">Default</option>
                            <option value="price_asc" {% if selected_sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
                            <option value="price_desc" {% if selected_sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
                            <option value="name_asc" {% if selected_sort == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                            <option value="name_desc" {% if selected_sort == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
                        </select>

                        <button type="submit" class="flex-[1] bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition">
                            Apply
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Product Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 pb-16 mt-6">
            {% for product in products %}
            <div class="group relative bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-2xl transition">
                <div class="relative h-64 bg-gray-100 overflow-hidden">
                    {% if product.main_image %}
                        <a href="{% url 'product_detail' product.slug %}">
                            <img src="{{ product.main_image.url }}" alt="{{ product.title }}" loading="lazy"
                                 class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                        </a>
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-400">
                            <i class="fas fa-image text-6xl opacity-50"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="p-6 space-y-3">
                    <h3 class="text-lg font-bold text-gray-800 group-hover:text-indigo-600 transition">
                        <a href="{% url 'product_detail' product.slug %}">{{ product.title }}</a>
                    </h3>
                    <p class="text-sm text-gray-500 line-clamp-2">{{ product.description|truncatewords:15 }}</p>
                    <div class="flex justify-between items-center">
                        <p class="text-2xl font-bold text-green-600">₹{{ product.price }}</p>
                        <div class="flex text-yellow-400">★★★★☆</div>
                    </div>
                    <div class="pt-4 flex gap-3">
                        <a href="{% url 'product_detail' product.slug %}" 
                           class="flex-1 bg-indigo-600 text-white py-2 rounded-lg text-center hover:bg-indigo-700 transition">
                           View
                        </a>
                        {% if not product.is_out_of_stock %}
                        <form action="{% url 'cart' %}" method="post" class="flex-1">
                            {% csrf_token %}
                            <input type="hidden" name="product_id" value="{{ product.id }}">
                            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">
                                <i class="fas fa-cart-plus"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Mobile-Friendly Pagination with Ellipsis -->
        {% if page_obj.has_other_pages %}
        <div class="flex justify-center flex-wrap gap-2 pb-12">

            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_brand %}&brand={{ selected_brand }}{% endif %}{% if selected_vehicle %}&vehicle_id={{ selected_vehicle }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}" 
                   class="px-3 py-2 bg-gray-200 rounded-lg text-sm sm:text-base">« Prev</a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if num == 1 or num == page_obj.paginator.num_pages or num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}

                    {% if num == page_obj.number %}
                        <span class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm sm:text-base">{{ num }}</span>
                    {% else %}
                        <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_brand %}&brand={{ selected_brand }}{% endif %}{% if selected_vehicle %}&vehicle_id={{ selected_vehicle }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}" 
                           class="px-3 py-2 bg-gray-200 rounded-lg text-sm sm:text-base">{{ num }}</a>
                    {% endif %}
                {% elif num == 2 and page_obj.number > 4 %}
                    <span class="px-3 py-2 text-gray-500">…</span>
                {% elif num == page_obj.paginator.num_pages|add:-1 and page_obj.number < page_obj.paginator.num_pages|add:-3 %}
                    <span class="px-3 py-2 text-gray-500">…</span>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_brand %}&brand={{ selected_brand }}{% endif %}{% if selected_vehicle %}&vehicle_id={{ selected_vehicle }}{% endif %}{% if selected_sort %}&sort={{ selected_sort }}{% endif %}" 
                   class="px-3 py-2 bg-gray-200 rounded-lg text-sm sm:text-base">Next »</a>
            {% endif %}

        </div>
        {% endif %}

    </div>
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<script>
window.addEventListener('scroll', () => {
    const bar = document.getElementById('filterBar');
    if(window.scrollY > 50) bar.classList.add('shadow-xl');
    else bar.classList.remove('shadow-xl');
});
</script>
{% endblock %}
